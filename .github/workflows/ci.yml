name: CI - Test and Validate

on:
  pull_request:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docs-only:
    name: "ci: docs-only"
    runs-on: ubuntu-latest
    outputs:
      docs-only: ${{ steps.detect.outputs.docs-only }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Detect docs-only changes
        id: detect
        uses: wphillipmoore/standard-actions/actions/docs-only-detect@develop

  standards-compliance:
    name: "ci: standards-compliance"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate standards
        uses: wphillipmoore/standard-actions/actions/standards-compliance@develop
        with:
          commit-cutoff-sha: "d103713"

  dependency-audit:
    name: "ci: dependency-audit"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Java 17
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Verify dependency resolution
        run: ./mvnw dependency:tree -B -q

      - name: Run license compliance check
        run: >-
          ./mvnw org.codehaus.mojo:license-maven-plugin:2.7.0:add-third-party
          -Dlicense.excludedScopes=test
          -Dlicense.failIfWarning=true
          "-Dlicense.includedLicenses=Apache-2.0|Apache 2.0|The Apache License, Version 2.0|MIT License|BSD-2-Clause|BSD-3-Clause|ISC|MPL-2.0|GPL-3.0-or-later"
          -B

  release-gates:
    name: "release: gates"
    runs-on: ubuntu-latest
    steps:
      - name: Skip on non-PR events
        if: github.event_name != 'pull_request'
        run: echo "Not a pull request; skipping release gates."

      - name: Checkout code
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Java 17
        if: github.event_name == 'pull_request'
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "17"

      - name: Version format gate (PRs targeting main)
        if: github.event_name == 'pull_request' && github.base_ref == 'main'
        run: |
          version=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)
          if ! echo "$version" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "FAIL: Version ($version) must be plain semver (x.y.z)."
            exit 1
          fi
          echo "OK: Version ($version) is valid semver."

      - name: Version divergence gate (PRs targeting develop)
        if: github.event_name == 'pull_request' && github.base_ref == 'develop'
        uses: wphillipmoore/standard-actions/actions/release-gates/version-divergence@develop
        with:
          head-version-command: ./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout
          main-version-command: git show origin/main:pom.xml | grep -m1 '<version>' | sed 's/.*<version>\(.*\)<\/version>.*/\1/'

  test-and-validate:
    name: "test: unit"
    runs-on: ubuntu-latest
    needs: docs-only
    strategy:
      matrix:
        java-version: ["17", "21", "25-ea"]

    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping test-and-validate."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6

      - name: Set up Java ${{ matrix.java-version }}
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ matrix.java-version }}
          cache: maven

      - name: Run full validation pipeline
        if: needs.docs-only.outputs.docs-only != 'true'
        run: ./mvnw verify -B

  codeql:
    name: "security: codeql"
    runs-on: ubuntu-latest
    needs: docs-only
    permissions:
      security-events: write
    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping CodeQL."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6

      - name: Run CodeQL analysis
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/standard-actions/actions/security/codeql@develop
        with:
          language: java

  trivy:
    name: "security: trivy"
    runs-on: ubuntu-latest
    needs: docs-only
    permissions:
      security-events: write
    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping Trivy."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scan
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/standard-actions/actions/security/trivy@develop
        with:
          scan-type: fs

  semgrep:
    name: "security: semgrep"
    runs-on: ubuntu-latest
    needs: docs-only
    permissions:
      security-events: write
    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping Semgrep."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6

      - name: Run Semgrep SAST scan
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/standard-actions/actions/security/semgrep@develop
        with:
          language: java

  integration-tests:
    name: "test: integration"
    runs-on: ubuntu-latest
    needs: docs-only
    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping integration tests."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6

      - name: Set up Java 17
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Setup MQ environment
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/mq-rest-admin-dev-environment/.github/actions/setup-mq@main
        with:
          project-name: mq-rest-admin
          qm1-rest-port: "9453"
          qm2-rest-port: "9454"

      - name: Run integration tests
        if: needs.docs-only.outputs.docs-only != 'true'
        env:
          MQ_REST_ADMIN_RUN_INTEGRATION: "1"
        run: ./mvnw verify -B
